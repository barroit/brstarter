/* SPDX-License-Identifier: GPL-3.0-or-later or MIT */
/*
 * Copyright 2024 Jiamu Sun <barroit@linux.com>
 */

#ifndef NG39_UNITEST_H
#define NG39_UNITEST_H

#include <stddef.h>

#include "attr.h"
#include "compiler.h"

#define __UT_PTH_TMP    "@UT_PTH_TMP@"
#define ut_tmpnam(name) __UT_PTH_TMP "/" name "_" STROF(__COUNTER__)

typedef void (*unitest_routine_t)(void);

extern unitest_routine_t __testdecl_begin[];
extern unitest_routine_t __testdecl_end[];

extern unitest_routine_t __testdecl_setup;
extern unitest_routine_t __testdecl_teardown;

#define __test_section \
	__section(".miku_test") __used

#define __func_decl(name) \
	static void name(void)

#define __secvar_decl(name) \
	__test_section static unitest_routine_t CONCAT(__testdecl_, name)

#define __TESTDECL(name, lvalue) \
	__func_decl(name); lvalue = name; __func_decl(name)

#define TESTDECL_ROUTINE(name) \
	__TESTDECL(name, __secvar_decl(name))

#define TESTDECL_BEGIN(...) ADAP_CALL(__TESTDECL_BEGIN_, ##__VA_ARGS__)

#define __TESTDECL_BEGIN \
	__test_section unitest_routine_t __testdecl_begin[] = { 0 }

#define __TESTDECL_BEGIN_0() \
	__TESTDECL_BEGIN; \
	unitest_routine_t __testdecl_setup = NULL

#define __TESTDECL_BEGIN_1(name) \
	__TESTDECL_BEGIN; \
	__TESTDECL(name, unitest_routine_t __testdecl_setup)

#define TESTDECL_END(...) ADAP_CALL(__TESTDECL_END_, ##__VA_ARGS__)

#define __TESTDECL_END \
	__test_section unitest_routine_t __testdecl_end[] = { 0 }

#define __TESTDECL_END_0() \
	__TESTDECL_END; \
	unitest_routine_t __testdecl_teardown = NULL

#define __TESTDECL_END_1(name) \
	__TESTDECL_END; \
	__TESTDECL(name, unitest_routine_t __testdecl_teardown)

#endif /* NG39_UNITEST_H */
